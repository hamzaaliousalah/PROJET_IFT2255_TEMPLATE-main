<!DOCTYPE html>
<html lang="en">
<head>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>projet ift2255</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>OUTIL DE CONSEILS PLANIFI


            <!--= -->
            <!--= simple pr moi de load info en allant chercher par id et remplacer text-content-->
            <h4><b>Espace de</b> <span id="student-name"></span></h4>
            <p><b>Matricule:</b> <span id="student-matricule"></span></p>
            <p><b>Cours complétés:</b><span id="completed-courses"></span></p>
            <button onclick="logout()">Déconnexion</button>
        </div>
        <section>
            <h2>Étudiants inscrits</h2>
            <button onclick="loadUsers()">Charger les etudiants</button>
            <div id="users-list"></div>
        </section>

        <section>
            <h2>Courses</h2>
            <div>
                <input type="text" id="courseId" placeholder="Ex: IFT1015 ou IFT">
                <select id="term">
                    <option value="H">Hiver (H)</option>
                    <option value="E">Été (E)</option>
                    <option value="A" selected>Automne (A)</option>
                </select>
                <select id="year">
                    <option value="25" selected>2025</option>
                    <option value="26">2026</option>
                    <option value="27">2027</option>
                </select>
                <button onclick="searchCourse()">Chercher</button>
            </div>
            <div id="course-info"></div>
        </section>

        <section>
            <h2>Comparaison 2 cours</h2>
            <div>
                <input type="text" id="compare-courseA" placeholder="Cours A (ex: IFT1015)">
                <input type="text" id="compare-courseB" placeholder="Cours B (ex: IFT3700)">
                <button onclick="compareCourses()">Comparer</button>
            </div>
            <div id="compare-result"></div>
        </section>

        <h2>Avis form</h2>
        <section class="avis-section">



            <div>
                <h3>Consulter les avis</h3>
                <div class="myform avis-form">
                    <input type="text" id="avis-search-coursebyid" placeholder="Ex: IFT1015">
                    <button onclick="loadAvis()">Voir les avis</button>
                    <button onclick="loadAvisStats()">Voir les stats</button>
                    <div id="avis-list"></div>
                </div>
            </div>

            <div>
                <h3>Laisser un avis</h3>
                <form id="createAvisForm" class="myform">
                    <input type="text" id="avis-courseId" placeholder="Sigle (ABC1234)" required>
                    <input type="number" id="avis-rating" placeholder="Note (1-5)" min="1" max="5" required>
                    <input type="number" id="avis-difficulty" placeholder="Difficulté (1-5)" min="1" max="5" required>
                    <input type="number" id="avis-charge" placeholder="Charge (1-5)" min="1" max="5" required>
                    <input type="text" id="avis-comment" placeholder="Commentaire" required>
                    <button type="submit">Envoyer</button>
                </form>
                <div id="avis-form-result"></div>
            </div>
        </section>


        <!--
        <section>
            <h2>modifier une personne ??(juste tgde)</h2>
            <form id="createUserForm">
                <input type="text" id="userName" placeholder="Nom" required>
                <input type="matricule" id="userMatricule" placeholder="Matricule" required>
                <button type="submit">Créer</button>
            </form>
        </section>

        -->
        <section>
            <h2>Conseiller ai de Planifume</h2>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Posez une question sur les cours...">
                    <button onclick="sendMessage()">Envoyer</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        //const API_URL = 'http://localhost:3000';
        const params = new URLSearchParams(window.location.search);
        const matricule = params.get('matricule');

        if (!matricule) {
            window.location.href = "landing.html";
            //oui cpas le top securité mais anyways
        }

        let currentStudent = null; //fetch les info de la personne

        async function loadStudent() {
            const response = await fetch(`http://localhost:3000/students/${matricule}`);
            currentStudent = await response.json();

            document.getElementById('student-name').textContent = currentStudent.name;
            document.getElementById('student-matricule').textContent = currentStudent.matricule;
            document.getElementById('completed-courses').textContent =
            currentStudent.completedCourses.join(', ') || 'Aucun cours credité/complete';
        }

        loadStudent()



        function displayCourses(courses) {
            const container = document.getElementById('course-info');
            container.innerHTML = '';

            if (courses.length === 0) {
                container.innerHTML = '<p>Aucun cours trouvé</p>';
                return;
            }

            courses.forEach(course => {
                const div = document.createElement('div');
                div.classList.add('course-card');
                div.innerHTML = `
                    <h3>${course.id} - ${course.name}</h3>
                    <p>${course.description || 'Pas de description disponible'}</p>
                `;
                container.appendChild(div);
            });
        }
        async function compareCourses() {
            const courseA = document.getElementById('compare-courseA').value.trim().toUpperCase();
            const courseB = document.getElementById('compare-courseB').value.trim().toUpperCase();

            if (!courseA || !courseB) {
                showError('compare-result', 'Veuillez entrer deux cours à comparer');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/compare?courseA=${courseA}&courseB=${courseB}`);

                if (!response.ok) {
                    throw new Error('Erreur lors de la comparaison');
                }

                const result = await response.json();
                displayComparison(result, courseA, courseB);
            } catch (error) {
                showError('compare-result', error.message);
            }
        }

        function displayComparison(result, courseA, courseB) {
            const container = document.getElementById('compare-result');


            let meilleurenoteAvis = 'égalité';
            if (result.avgRatingA > result.avgRatingB) {
                meilleurenoteAvis = courseA;
            } else if (result.avgRatingB > result.avgRatingA) {
                meilleurenoteAvis = courseB;
            }


            let scoreFacile = 'Égalité';
            if (result.scoreAcademiqueA > result.scoreAcademiqueB) {
                scoreFacile = courseA;
            } else if (result.scoreAcademiqueB > result.scoreAcademiqueA) {
                scoreFacile = courseB;
            }

            container.innerHTML = `
                <div class="course-card">

                    <h3>Comparaison: ${courseA} vs ${courseB}</h3>
                    <br>
                    <p><b>Note moyenne (avis) ${courseA}:</b> ${result.avgRatingA}/5</p>
                    <p><b>Note moyenne (avis) ${courseB}:</b> ${result.avgRatingB}/5</p>
                    <br>
                    <p><b>Score académique ${courseA}:</b> ${result.scoreAcademiqueA}</p>
                    <p><b>Score académique ${courseB}:</b> ${result.scoreAcademiqueB}</p>
                    <br>
                    <p><b>Différence de crédits:</b> ${result.creditDifference}</p>
                    <br>
                    <p><b>Mieux noté (avis):</b> ${meilleurenoteAvis}</p>
                    <p><b>Plus facile (résultats):</b> ${scoreFacile}</p>
                </div>
            `;
        }

//////la parite bonus chatbot///
        const CHATBOT_URL = 'http://localhost:5000';

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const messagesDiv = document.getElementById('chat-messages');
            ///le msg du user
            messagesDiv.innerHTML += `<div class="user-message"><b>Etudiant:</b> ${message}</div>`;
            input.value = '';
            messagesDiv.innerHTML += `<div class="bot-typing" id="typing">Botudem est en train d'écrire...</div>`;

            try {
                const response = await fetch(`${CHATBOT_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: matricule || 'anonymous'
                    })
                });

                const data = await response.json();

                document.getElementById('typing')?.remove(); //quand le llm calcul une reponse on enleve le waiting state

                messagesDiv.innerHTML += `<div class="bot-message"><b>Bot:</b> ${data.response}</div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

            } catch (error) {
                document.getElementById('typing')?.remove();
                messagesDiv.innerHTML += `<div class="error">Erreur: le chatbot ne répond pas</div>`;
            }
        }

        //le bouton pr send
        document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });


    </script>

    <script src="app.js"></script>

</body>
</html>